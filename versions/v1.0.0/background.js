const defaultOrigins=[{url:"*://datav.aliyun.com/screen/*",readonly:!0,disabled:!1}];let origins=[];const receiveMessage=()=>{chrome.runtime.onMessage.addListener((e,r,i)=>{"addUrl"===e.type?setOrigin({url:e.url,disabled:!1}):"delUrl"===e.type&&setOrigin({url:e.url},!0),i({status:"ok"})})},setOrigin=async(s,e=!1)=>{if(e){let i=null;origins.find((e,r)=>{e=e.url===s.url;return e&&(i=r),e}),null!==i&&origins.splice(i,1)}else origins.push(s);await chrome.storage.sync.set({origins:origins})},requestHandler=()=>{chrome.webRequest.onCompleted.addListener(e=>{const{frameType:r,type:i,method:s,statusCode:t}=e;"sub_frame"===r&&"xmlhttprequest"===i&&"POST"===s&&chrome.tabs.query({active:!0,currentWindow:!0},([e])=>{chrome.tabs.sendMessage(e.id,{type:"request",status:t})})},{urls:["*://*/api/admin/screen/*"]})},injectScript=()=>{chrome.tabs.onUpdated.addListener(async(e,r,i)=>{if("loading"==r.status&&"loading"==i.status&&null!=i.url){const s=await chrome.webNavigation.getAllFrames({tabId:i.id});1===s.length&&"outermost_frame"===s[0].frameType&&origins.forEach(({url:e,readonly:r})=>{r||-1===i.url.indexOf(e)||(chrome.scripting.executeScript({target:{tabId:i.id,frameIds:[s[0].frameId]},files:["content.js"]}),chrome.scripting.insertCSS({target:{tabId:i.id,frameIds:[s[0].frameId]},files:["content.css"]}))})}})},init=async()=>{chrome.storage.onChanged.addListener(e=>{let r=[];e.origins&&e.origins.newValue&&(origins=e.origins.newValue,r=origins),chrome.runtime.sendMessage({type:"storageChange",origins:r})});var e=await chrome.storage.sync.get("origins");e.origins&&e.origins.length?origins=e.origins:await chrome.storage.sync.set({origins:defaultOrigins}),requestHandler(),receiveMessage(),injectScript()};init();